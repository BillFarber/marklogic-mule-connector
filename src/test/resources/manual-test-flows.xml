<!--
Not able to run the flows in here in JUnit yet as Mule's test runner doesn't recognize the "batch" or "ee" libraries.
You can copy/paste this into Anypoint for quick manual testing of the flows.
-->
<mule
    xmlns="http://www.mulesoft.org/schema/mule/core"
    xmlns:batch="http://www.mulesoft.org/schema/mule/batch"
    xmlns:marklogic="http://www.mulesoft.org/schema/mule/marklogic"
    xmlns:http="http://www.mulesoft.org/schema/mule/http"
    xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
  http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
  http://www.mulesoft.org/schema/mule/marklogic http://www.mulesoft.org/schema/mule/marklogic/current/mule-marklogic.xsd
  http://www.mulesoft.org/schema/mule/batch http://www.mulesoft.org/schema/mule/batch/current/mule-batch.xsd
  http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd"
>

  <http:listener-config name="httpConfig">
    <http:listener-connection host="0.0.0.0" port="8082"/>
  </http:listener-config>

  <marklogic:config name="config" configId="MarkLogicConfig">
    <marklogic:connection
        host="localhost"
        port="8022"
        username="mule2-test-user"
        password="password"
        authenticationType="DIGEST"/>
  </marklogic:config>

  <!--
  Reads the 10 test documents in the "batch-input" collection and then writes them 5 at a time.
  -->
  <flow name="readTenDocsWriteTwoBatches">
    <http:listener config-ref="httpConfig" path="/many"/>
    <marklogic:read-documents config-ref="config" collection="batch-input"/>
    <batch:job jobName="MyJob">
      <batch:process-records>
        <batch:step name="MyStep1">
          <batch:aggregator size="5">
            <marklogic:write-batch config-ref="config"/>
          </batch:aggregator>
        </batch:step>
      </batch:process-records>
    </batch:job>
    <ee:transform>
      <ee:message>
        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	"this is here": "just for a friendly browser response"
}]]></ee:set-payload>
      </ee:message>
    </ee:transform>
  </flow>

</mule>
